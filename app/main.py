import json
import os
import traceback

from functools import lru_cache
from typing import Annotated
import requests

from fastapi import FastAPI, Path
from fastapi.responses import HTMLResponse, Response
from pybadges import badge

# CONSTANTS
MIRTRE_API_ENDPOINT = 'https://cveawg.mitre.org/api/cve/'
NIST_API_ENDPOINT = 'https://services.nvd.nist.gov/rest/json/cves/2.0'
NIST_DISCLAIMER = 'This product uses the NVD API but is not endorsed or certified by the NVD.'
CVE_REDIRECT_LINK = 'https://cve.mitre.org/cgi-bin/cvename.cgi?name='
DEFAULT_VALUE = '?'
DEFAULT_COLOR = '#888'
YEAR_DOC = "The year of publication of the CVE"
ID_DOC = "The ID of the CVE"
REQUESTS_TIMEOUT_SECONDS = 7

# INIT APP
app = FastAPI()


# CLASS DECLARATION
class SVGResponse(HTMLResponse):
    media_type = "image/svg+xml"


# UTILS
def rgb_to_hex(r:int, g:int, b:int) -> str:
    return f'#{r:02x}{g:02x}{b:02x}'


@lru_cache
def fetch_data_from_cve_org(cve_id:str) -> dict:
    url = MIRTRE_API_ENDPOINT + f"CVE-{cve_id}"
    try:
        response = requests.get(url, timeout=REQUESTS_TIMEOUT_SECONDS)
        return response.json()
    except Exception as e:
        print(e)
        print(url)
        return {}
    
@lru_cache
def fetch_data_from_nist(cve_id:str) -> dict:
    ''' Fetch fata from NIST API '''
    api_key = os.getenv('NIST_API_KEY')
    try:
        url = NIST_API_ENDPOINT
        params = {'cveId': 'CVE-'+cve_id}
        headers = {'apiKey': api_key}
        response = requests.get(url, headers=headers, params=params, timeout=REQUESTS_TIMEOUT_SECONDS)
        response.raise_for_status()
        return response.json()
    except Exception as e:
        return {}


def get_cvss_score_from_nist(cve_id:str):
    data = fetch_data_from_nist(cve_id)
    level = level_name = None
    version = 0
    try:
        metrics = data['vulnerabilities'][0]['cve']['metrics']
        for _, metric_list in metrics.items():
            for metric in metric_list:
                if metric['type'] != 'Primary':
                    continue
                data = metric['cvssData']
                if (isinstance(data, dict) and 'baseScore' in data.keys()):
                    v = float(data['version'])
                    if (v > version):
                        level = data['baseScore']
                        level_name = data['baseSeverity']
                        version = v
    except (ValueError, TypeError, KeyError) as e:
        # Error is expected in case 'metrics' is not in response
        pass
    finally:
        return (level, level_name)

def get_cvss_score_from_cve_org(cve_id:str):
    data = fetch_data_from_cve_org(cve_id)
    level = level_name = None
    version = 0
    try:
        metrics = data['containers']['cna']['metrics']
        for metric in metrics:
            for key, val in metric.items():
                if ('cvss' in key and isinstance(val, dict) and 'baseScore' in val.keys()):
                    v = float(val['version'])
                    if (v > version):
                        level = val['baseScore']
                        level_name = val['baseSeverity']
                        version = v
    except (ValueError, TypeError, KeyError):
        # Error is expected in case 'metrics' is not in response
        pass
    finally:
        return (level, level_name)

def get_cvss_score(cve_id:str):
    values = get_cvss_score_from_cve_org(cve_id)
    if (None in values):
        values = get_cvss_score_from_nist(cve_id)
    return values

def build_svg(id:str, level:str, level_name:str) -> str:
    logo = "app/bug.svg"
    link = CVE_REDIRECT_LINK + id
    label = f'CVE-{id}'
    try:
        t = float(level)/10
        color = rgb_to_hex(*(int(255 * t), int(255 * (1 - t)), 50))
        value = f"{level_name} Â· {level}" if level_name else DEFAULT_VALUE
    except Exception:
        value = DEFAULT_VALUE
        color = DEFAULT_COLOR
    svg = badge(left_text=label, right_text=value, right_color=color,
                left_color="#222", logo=logo, embed_logo=True, left_link=link)
    return svg


# GET /cve-<year>-<id>
@app.get("/CVE-{year}-{id}",
         response_class=SVGResponse,
         responses={200: {"description": "Return the badge as SVG image."}})
async def cve_badge(
        year=Annotated[int, Path(title=YEAR_DOC, gt=1900, le=2100)],
        id=Annotated[int, Path(title=ID_DOC, gt=1, le=99999999)]):
    year, id = int(year), int(id)
    cve_id = f'{year}-{id:04}'
    score, label = get_cvss_score(cve_id)
    image = build_svg(cve_id, score, label)
    return Response(image, media_type="image/svg+xml")
