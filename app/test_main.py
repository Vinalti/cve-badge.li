from fastapi.testclient import TestClient

from .main import app, get_label_from_score

client = TestClient(app)


# TEST INVALID REQUESTS
def test_404_page():
    response = client.get("/404")
    assert response.status_code == 404
    assert response.json() == {
        "detail": "Not Found"
    }


def test_unknown_cve():
    response = client.get("/CVE-2010-9999")
    assert response.status_code == 200
    assert ">?</text" in response.text
    assert "MEDIUM" not in response.text
    assert "LOW" not in response.text
    assert "HIGH" not in response.text
    assert "CRITICAL" not in response.text


# TEST VALID REQUESTS
def test_valid_cve_LOW38_CVSS_3_1():
    response = client.get("/CVE-2022-2106")
    assert response.status_code == 200
    assert "LOW" in response.text
    assert "3.8" in response.text


def test_valid_cve_MEDIUM53_CVSS_3_1():
    response = client.get("/CVE-2022-2117")
    assert response.status_code == 200
    assert "MEDIUM" in response.text
    assert "5.3" in response.text


def test_valid_cve_CRITICAL98_CVSS_3_1():
    response = client.get("/CVE-2023-0750")
    assert response.status_code == 200
    assert "CRITICAL" in response.text
    assert "9.8" in response.text


def test_valid_cve_LOW35_CVSS_3_1_and_less():
    '''This test include metrics for cvss 3.1, 3.0 and 2.0.'''
    response = client.get("/CVE-2023-0732")
    assert response.status_code == 200
    assert "LOW" in response.text
    assert "3.2" in response.text


def test_valid_cve_CRITICAL96_CVSS3_0():
    '''This test checks that cvss v3.0 is working'''
    response = client.get('/CVE-2022-0153')
    assert response.status_code == 200
    assert "CRITICAL" in response.text
    assert "9.6" in response.text


def test_valid_cve_NIST_only_1():
    '''Checks that CVSS score not listed in CVE.org  is retrieved from NIST'''
    response = client.get('/CVE-2023-27603')
    assert response.status_code == 200
    assert "CRITICAL" in response.text
    assert "9.8" in response.text


def test_valid_cve_NIST_only_2():
    '''Checks that CVSS score not listed in CVE.org is retrieved from NIST'''
    response = client.get('/CVE-2023-0399')
    assert response.status_code == 200
    assert "MEDIUM" in response.text
    assert "5.4" in response.text

def test_old_cve_no_label():
    '''Checks that Severity label is displayed in old CVE from NIST'''
    response = client.get('/CVE-1999-0042')
    assert response.status_code == 200
    assert "CRITICAL" in response.text
    assert "10.0" in response.text

# SPECIFIC TEST ON LOCAL FUNCTIONS

def test_label_generation():
    assert get_label_from_score(-1) == 'NONE'
    assert get_label_from_score(0) == 'NONE'
    assert get_label_from_score(0.1) == 'LOW'
    assert get_label_from_score(3.9) == 'LOW'
    assert get_label_from_score(4.0) == 'MEDIUM'
    assert get_label_from_score(6.9) == 'MEDIUM'
    assert get_label_from_score(7.0) == 'HIGH'
    assert get_label_from_score(8.9) == 'HIGH'
    assert get_label_from_score(9) == 'CRITICAL'
    assert get_label_from_score(10) == 'CRITICAL'